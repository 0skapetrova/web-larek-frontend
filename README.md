# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении

Товар

```
interface IProduct {
    id: string;
    description: string;
    image: string;
    title: string;
    category: string;
    price: number;
}
```

Покупатель

```
interface IClient {
    payment: string;
    address: string;
    email: string;
    phone: string;
}
```

Интерфейс для модели данных товаров
```
interface IProductList {
    products: IProduct[];
    preview: string | null;
    getProduct(productId: string): IProduct;
}
```

Данные карточки, используемые в модальном окне корзины

```
export type TProductBaseInfo = Pick<IProduct, 'id' | 'title' | 'price'>;
```

Данные покупателя, используемые в форме данных заказа

```
export type TClientOrderData = Pick<IClient, 'paymentMethod' | 'address'>;
```

Данные покупателя, используемые в форме данных покупателя

```
export type TClientPersonalData = Pick<IClient, 'email' | 'phoneNumber'>;
```

## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVC:
- слой данных, отвечающий за хранение и изменение данных
- слой представления, отвечающий за отображение данных на странице
- контроллер, отвечающий за взаимодействие данных и представления, обрабатывая события

### Базовый код

#### Класс BaseApi
Содержит в себе базовую логику отправки запросов./
- constructor(baseUrl: string, options: RequestInit = {}) В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы: 
- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.  
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие

### Слой данных


#### Класс ProductsData
Класс отвечает за хранение и работу с данными товаров.\
- constructor (events: IEvents) Конструктор класса принимает экземпляр класса EventEmitter для создания событий\

Поля класса:
- _products: IProduct[] - массив объектов товаров
- _preview: string | null - id товара, выбранного для просмотра в модальном окне
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных

Методы:
- set products(products:IProduct[]): IProduct[] - сеттер списка товаров
- get products (): IProduct[] - геттер списка товаров
- getProduct(productId: string): IProduct - метод для получения одного товара по id


#### Класс CartData
Класс отвечает за хранение и работу с данными товаров для покупки.\
- constructor (events: IEvents) Конструктор класса принимает экземпляр класса EventEmitter для создания событий\

Поля класса:
- _products: IProduct[] - массив объектов товаров
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных

Методы:
- get products(): IProduct[] - геттер списка товаров в корзине
- get productsForOrder(): IProduct[] - геттер товаров для заказа за вычетом бесценного товара
- addProduct(product: IProduct): void - метод для добавления одного товара, вызывает событие изменения массива
- deleteProduct(productId: string): void - метод для удаления товара по id, вызывает событие изменения массива
- emptyBasket(): void - метод для очистки корзины
- getCount(): number - метод для подсчета количества товаров в корзине
- getTotal(): number - метод для подсчета общей стоимости товаров в корзине, исключая бесценный
- isEmpty(): boolean - метод для проверки наличия товаров в корзине для управления состоянием кнопки



#### Класс ClientData
Класс отвечает за хранение и работу с данными покупателя.\
- constructor (events: IEvents) Конструктор класса принимает экземпляр класса EventEmitter для создания событий\

Поля класса:
- _payment: string - способ оплаты
- _address: string - адрес доставки
- _email: string - адрес электронной почты
- _phone: string - номер телефона
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных

Методы:
- getClientData(): IClient - возвращает данные покупателя
- геттеры и сеттеры для всех свойств объекта 


### Слой представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.


#### Базовый класс Component
Класс является дженериком и родителем всех компонентов слоя представления. В дженерик принимает тип объекта, в котором данные будут передаваться в метод render для отображения данных в компоненте. В конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента. Содержит метод render, отвечающий за сохранение полученных в параметре данных в полях компонентов через их сеттеры, возвращает обновленный контейнер компонента.


#### Базовый класс Modal
Реализует модальное окно. Так же предоставляет методы `open` и `close` для управления отображением модального окна. Устанавливает слушатели на клавиатуру, для закрытия модального окна по Esc, на клик в оверлей и кнопку-крестик для закрытия попапа.  
- constructor(template: HTMLTemplateElement, events: IEvents) Конструктор принимает темплейт необходимого модального окна и экземпляр класса `EventEmitter` для возможности инициации событий.

Поля класса
- modal: HTMLElement - элемент модального окна
- template: HTMLTemplateElement - темплейт
- events: IEvents - брокер событий


#### Класс Cart
Предназначен для реализации модального окна корзины.
Предоставляет методы для отображения списка товаров и общей стоимости.

Поля класса:
- _items: HTMLElement[] - элемент разметки для отображения списка товаров для покупки
- _button: HTMLButtonElement - Кнопка подтверждения
- _total: HTMLElement - элемент разметки для отображения стоимости заказа


#### Базовый класс Form
Предназначен для реализации модального окна с формой содержащей поля ввода. При сабмите инициирует событие передавая в него объект с данными из полей ввода формы. При изменении данных в полях ввода инициирует событие изменения данных. Предоставляет методы для отображения ошибок и управления активностью кнопки.\

Поля класса:
- _submit: HTMLButtonElement - Кнопка подтверждения
- _errors: HTMLElement - объект хранящий элемент для вывода ошибок под полями формы

Методы:
- set valid(value: boolean) - изменяет активность кнопки подтверждения
- set errors(value: string) - устанавливает текст ошибки
- onInputChange(field: keyof T, value: string) - инициирует событие передавая в него объект с данными из полей ввода формы
<!-- - setInputValues(data: Record<string, string>): void - принимает объект с данными для заполнения полей формы -->
<!-- - setError(data: { field: string, value: string, validInformation: string }): void - принимает объект с данными для отображения или сокрытия текстов ошибок под полями ввода
- showInputError (field: string, errorMessage: string): void - отображает полученный текст ошибки под указанным полем ввода
- hideInputError (field: string): void - очищает текст ошибки под указанным полем ввода
- close (): void - расширяет родительский метод дополнительно при закрытии очищая поля формы и деактивируя кнопку сохранения
- get form: HTMLElement - геттер для получения элемента формы -->

#### Класс Order
Предназначен для реализации модального окна заполнения данных заказа.\
- constructor(container: HTMLFormElement, events: IEvents) В конструктор принимает контейнер и экземпляр класса EventEmitter.

В методах реализует сеттеры для получения данных из полей ввода.


#### Класс Contacts
Предназначен для реализации модального окна успешного заказа.\
- constructor(container: HTMLFormElement, events: IEvents) В конструктор принимает контейнер и экземпляр класса EventEmitter.

В методах реализует сеттеры для получения данных из полей ввода.


#### Класс Success
Предназначен для реализации модального окна успешного заказа.\
- constructor(container: HTMLElement, actions?: ISuccessActions) В конструктор принимает контейнер и колбэк для выполнения после закрытия модального окна.
Поля класса:
- _close: HTMLButtonElement - Кнопка подтверждения
- _total: HTMLElement - элемент разметки для отображения итоговой стоимости заказа 

Методы:
-set total (total: number) - устанавливает значение итоговой стоимости заказа


#### Класс Product 
Отвечает за отображение карточки товара, задавая в карточке данные названия, изображения, категории, описания и стоимости товара. Класс используется для отображения товаров на странице сайта.\
- constructor(template: HTMLTemplateElement, events: IEvents, actions?: ICardActions) В конструктор класса передается DOM элемент темплейта, что позволяет при необходимости формировать карточки товара разных вариантов верстки. В классе устанавливаются слушатели на все интерактивные элементы, в результате взаимодействия с которыми пользователя генерируются соответствующие события.\
Поля класса содержат элементы разметки элементов карточки. Конструктор, кроме темплейта принимает экземпляр `EventEmitter` для инициации событий.\

Методы:
- render(productData: IProduct): HTMLElement - Заполняет атрибуты элементов карточки товара данными. Метод возвращает разметку карточки с установленными слушателями. Слушатели устанавливаются на все интерактивные элементы карточки и генерируют соответствующие события через экземпляр брокера событий.
- геттер id возвращает уникальный id товара

#### Класс Page
Отвечает за отображение главной страницы сайта. В метод render принимает каталог товаров и данные о количестве товаров в корзине для отображения счетчика.

### Слой коммуникации

#### Класс AppApi
Расширяет родительский класс BaseApi и содержит в себе методы для работы с бэкендом./
- constructor(cdn: string, baseUrl: string, options?: RequestInit) В конструктор передается cdn для загрузки изображений, базовый адрес сервера и опциональный объект с заголовками запросов.
Методы: 
- getProduct(id: string): Promise<IProduct> - метод для получения и обработки данных одного товара
- getProducts(): Promise<IProduct[]> - метод для получения и обработки всего массива товаров
- placeOrder(data: IOrder): Promise<OrderResponse> - принимает объект с данными, и вызывает post метод родителя

## Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

При запуске страницы получаем список товаров с сервера и отображаем каталог товаров.
При клике на товар открываем модальное окна товара.
При клике на корзину открываем модальное окно корзины.
При клике на кнопку купить в карточке товара добавляем товар в корзину.
При клике на крестик в модальном окне товара закрываем модальное окно товара.

После открытия корзины отображается модальное окно в состоянии корзина.
Данные для этого состояния мы берем из модели данных корзина.
При клике на кнопку оформить модальное окно козины переходит в  модальное окно с формой оформления заказа
При клике на кнопку далее у формы оформления заказа переходим на форму данных пользователя
При клике на кнопку оплатить собираем данные для заказа из корзины и форм в один объект и отправляем на сервер для оформления заказа. При успешном ответе модальное окно корзины переводим в состояние успешно.
В состоянии успешно корзину очищаем, необходимые данные берем из заказа.
При нажатии на крестик закрываем модальное окно корзины, состояние переводим в состояние корзина, формы очищаем
При нажатии на иконку урны происходит удаление товара из корзины. При этом происходит проверка на количество товаров в корзине. Если удаляется последний товар, то закрываем корзину и очищаем формы.


Список событий:
События изменения данных (генерируются классами моделями данных):
- `cart: changed` - изменение массива товаров в корзине
- `client: set` - получение данных покупателя 
- `product: selected` - изменение товара для показа в модальном окне
- `product: previewClear` - необходима очистка данных товара для показа в модальном окне

События, возникающие при взаимодействии пользователя с интерфейсом:
- `product:select` - выбор товара для открытия в модальном окне
- `cart:open` - открытие модального окна корзины
- `product:buy` - выбор товара для покупки (нажатие на кнопку "купить")
- `productInBasket:delete` - удаление товара из корзины
- `order: open` - продолжение оформления заказа (нажатие на кнопку "оформить" в корзине)
- `paymentMethod: select` - выбор способа оплаты
- `address:input` - изменение данных в форме с адресом
- `email:input` - изменение данных в форме с адресом электронной почты
- `phoneNumber:input` - изменение данных в форме с номером телефона
- `address:validation` - необходима валидация данных в форме с адресом
- `email:validation` - необходима валидация данных в форме с адресом электронной почты
- `phoneNumber:validation` - необходима валидация данных в форме с номером телефона
- `orderData:submit` - подтверждение отправки данных в форме данных заказа
- `clientData:submit` - подтверждение отправки данных в форме данных покупателя
